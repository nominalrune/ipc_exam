## 問3 Webセキュリティに関する次の記述を読んで、設問に答えよ。

D社は、従業員 1,000名の小売業である。自社のホームページやECサイトなどのWebサイトについては、Webアプリケーションプログラム(以下、Web アプリという)に対する診断(以下, Web アプリ診断という)を専門会社のZ社に委託して実施している。Webアプリ診断は、Web サイトのリリース前だけではなく、リリース後も定期的に実施している。Z社のWeb アプリ診断は、脆弱性診断ツールによるスキャンだけではなく、手動による高度な分析も行う。

### [新たなWebサイトの構築]

D社では、新たにECサイトX(以下、サイトXという)と商品企画サイトY(以下、サイトYという)をW社が提供するクラウドサービス(以下、クラウドWという) 上に構築することになった。

サイトXでは、D社が取り扱う商品をインターネットを介して会員に販売する予定である。取引は毎月10,000件ほどを見込んでいる。サイトYでは、サイトXで販売する新商品の企画・開発を顧客参加型で行う。サイトXとサイトYは、いずれも Webサーバとデータベースサーバ(以下、DBサーバという)で構成する。WebサーバについてはクラウドWの仮想 Web サーバサービスを利用し、DBサーバについてはクラウドWのリレーショナルデータベースサービスを利用する。サイトXとサイトYはいずれも、コンテンツマネジメントシステム (以下, CMS という)を使って構築される。サイトXとサイトYにはいずれも、Webアプリ、HTMLによる静的コンテンツ, DBサーバに格納したデータを使った動的コンテンツなどを用意する。

D社は、V大学と新商品開発の共同研究を行っている。新商品開発の共同研究では、V大学が運用する情報交換サイト(以下、サイトPという)を利用している。サイトYは、サイトPで取り扱っている情報などを表示する。

D社は、Webサイト構築に関連するデータやドキュメントの保存場所として、クラウドWのストレージサービス(以下、ストレージWという)を利用する。

D社は、サイトX及びサイトYの設計書を作成した。設計書のうち、サイト X, サイトY及びサイトPのネットワーク構成を図1に、サーバやサービスの説明を図2に示す。

**図1 サイトX, サイトY及びサイトPのネットワーク構成**
*IG: インターネットゲートウェイ*
*FW: ファイアウォール*
*IMDS: インスタンスメタデータサービス VG: VPNゲートウェイ VPC: 仮想プライベートクラウド*
*注1) VPCとインターネットとの間の通信を可能にする。*
*注2) VPCとD社の内部ネットワークとの間のVPN通信を可能にする。*

```mermaid
graph TD
    subgraph D社
        D_Admin[D社管理者PC]
        D_Net[内部ネットワーク]
        D_Admin --> D_Net
    end

    subgraph V大学
        V_FW[FW]
        subgraph サイトP
            Web_P[WebサーバP]
            DB_P[DBサーバP]
            Web_P --> DB_P
        end
        V_FW --> Web_P
        V_Net[学内ネットワーク]
    end

    Internet[インターネット]

    subgraph クラウドW
        StorageW[ストレージW]
        VPC
        IMDS
        IG[IG <sup>1)</sup>]
        VG[VG <sup>2)</sup>]

        subgraph VPC
            subgraph サイトX
                Web_X[WebサーバX]
                DB_X[DBサーバX]
                Web_X --> DB_X
            end
            subgraph サイトY
                Web_Y[WebサーバY]
                DB_Y[DBサーバY]
                Web_Y --> DB_Y
            end
        end

        Web_X -- to IMDS --> IMDS
        Web_Y -- to IMDS --> IMDS
        Web_X -- to IG --> IG
        Web_Y -- to IG --> IG
    end

    D_Net -- VPN --> VG
    Internet -- to IG --> IG
    Internet -- to V_FW --> V_FW
    Internet -- to StorageW --> StorageW
    Web_Y -- to Internet --> Internet
```

**図2 サーバやサービスの説明**

  - **[クラウドWにあるサーバ及びストレージWについて]**
      - クラウド W上のサービスの管理のためのアクセスの際は、クラウド W用の利用者ID アクセスキーなどのクレデンシャル情報をリクエストに含める必要がある。D社が利用するクラウドW上のサービスには、D社用に発行されたクレデンシャル情報でアクセスでき、全ての操作ができる。
  - **[IMDS について]**
      - IMDSは、VPCの各サーバから特定のURLにアクセスされると特定の情報を返す。例えば、`https://100.000.000.000/meta-data/credential` に GET メソッドでアクセスされると、クラウド W 上のサービスのクレデンシャル情報を返す。IMDSには、インターネットから直接アクセスできないプライベートIPアドレス (○○○.○○○.○○○.○○○) が設定されている。
      - IMDS にアクセスする方式は、次のいずれかを採用する必要がある。D社では、方式1を採用する。
          - **方式1:** 特定のURLにアクセスするだけで情報を取得できる。
          - **方式2:** トークンを発行するURLにPUT メソッドでアクセスし、レスポンスボディに含まれるトークンを入手してから、そのトークンをリクエストヘッダに含めて特定のURLにアクセスすると情報を取得できる。
  - **[CMS について]**
      - Web サーバXの`https://[サイトXのFQDN].jp/admin` 又は Web サーバYの`https://[サイトYのFQDN].jp/admin` にアクセスすると、それぞれのサーバの CMS の管理ログイン画面にアクセスできる。ログインは、POST メソッドでは許可されるが、GETメソッドでは許可されない。各CMS の管理ログイン画面へのアクセスは、VPN接続されたD社管理者PC、又はVPC内からのアクセスだけに制限される。D社では、各CMS の管理者アカウントは初期パスワードのまま運用する。

### [サイトX]

サイトXには、会員用の利用者アカウントとD社管理者用の利用者アカウントがある。サイトXのログインセッション管理は, cookie パラメータのSESSIONIDで行う。SESSIONIDには、値と Secure 属性だけがセットされる。なお、サーバ側のセッションの有効期間は24時間である。設計書のうち、サイトXの機能一覧を表1に示す。

**表1 サイトXの機能一覧(抜粋)**
| 項番 | 機能 | 詳細機能 | 機能概要 |
| :--- | :--- | :--- | :--- |
| 1 | ログイン機能 | ログイン機能 | 利用者 IDとパスワードを入力し、ログインに成功すると利用できる機能が表示されるページに遷移する。 |
| 2 | 利用者機能 (ログイン前) | 会員機能(登録) | 登録画面では最初にメールアドレスを入力する。そのメールアドレス宛てに送られた電子メールに記載されたURLにアクセスして利用者情報を入力し、登録する |
| 3 | 利用者機能 (ログイン後) | 注文機能(商品検索,注文,注文履歴閲覧) | 商品には商品コードが付与されており、商品検索画面で検索できる。注文履歴は、注文年月である数字6桁とランダムな英大文字6桁の値をハイフンでつないだ注文管理番号で管理される。注文履歴を閲覧する際は、注文管理番号を基に検索する |
| 4 | | 会員機能(編集) | 登録した利用者情報を編集できる。 |
| 5 | | 問合せ機能 | 問合せ情報を入力できる。入力した問合せ情報は、数字10桁の管理番号が発番され、管理される。 |
| 6 | サイト管理機能 (ログイン後) | 商品管理機能(登録,編集,削除) | 商品情報を登録、編集、削除できる。商品情報が登録されると、数字 10桁の商品コードが割り当てられ、その商品を会員が注文できるようになる。 |
| 7 | | 売上管理機能(売上情報閲覧,検索) | 商品の売上情報を閲覧できる。また、条件を指定して検索することができる。 |
| 8 | | 会員管理機能 (閲覧,変更,削除) | 登録された会員の利用者情報を閲覧、変更,削除できる。 |
| 9 | | 問合せ管理機能 | 問合せ機能で入力された問合せ情報が閲覧できる。 |

サイト管理機能は、D社の内部ネットワーク以外からも利用する可能性があり、サイトXでは、接続元の制限は行わない。

サイトXとサイトYの構築は順調に進み、D社はリリース前の Web アプリ診断をZ社に委託した。Z社は、サイトXとサイトYそれぞれに対して Web アプリ診断を実施した。

### [サイトXに対する Web アプリ診断]

サイトXに対する Web アプリ診断では、次の三つの脆弱性が検出された。

  - クロスサイトスクリプティング (以下, XSS という)
  - クロスサイトリクエストフォージェリ (以下、CSRF という)
  - 認可制御の不備

#### [XSS について]

Z社がXSS を検出した経緯は、次のとおりであった。

1.  問合せ機能で、脆弱性診断ツールによるリクエストとレスポンスを確認した。このときのリクエストとレスポンスは、図3のとおりであった。

**図3 問合せ機能のリクエストとレスポンス**
*注記 パラメータ name の値は`"><script>alert(1)</script><"` をURL エンコードした値である。*

```http
[リクエスト]
POST /shop/contact HTTP/1.1
Host: (省略)
(省略)
Content-Type: application/x-www-form-urlencoded
Content-Length: (省略)
Cookie: SESSIONID=nt1t3dmxmLmwuicyiz3h4nq1

subject_id=004&name=%22%3e%3cscript%3ealert%281%29%3c%2fscript%3e%3c%22&tel=(省略)&mail=(省略)&mail2=(省略)&comment=(省略)

[レスポンス]
(省略)
<h1>問合せを受け付けました。</h1>
(省略)
```

2.  図3中のレスポンスボディには、問合せ機能で入力した値は出力されていない。しかし、Z社は、①<u>設計書を調査した上で手動による分析を行い、図3 中のリクエスト内のスクリプトが別の機能の画面に出力されること</u>を確認した。

Z社は、②<u>攻撃者がこのXSSを悪用してサイトX内の全会員の利用者情報を取得する可能性がある</u>と説明した。

#### [CSRF について]

Z社がCSRF を検出した経緯は、次のとおりであった。

1.  会員機能(編集)において、図4に示すリクエストを送ってその応答を確認した。リクエストは正常に処理された。

**図4 会員機能 (編集) のリクエスト**

```http
POST /shop/editmember HTTP/1.1
Host: (省略)
(省略)
Content-Type: application/x-www-form-urlencoded
Content-Length: (省略)
Cookie: SESSIONID=b9y33f89umt6uua1pe4j4jn7

sei=sato&mei=taro&mail=aaa%40example.jp&csrf_token=KCR088ERH2G8MGT319E50SMOAJFDIVEM
```

2.  リクエスト内のメッセージボディの一部を変更して送り、その応答を確認した。リクエスト内のメッセージボディと応答は表2のとおりであった。

**表2 リクエスト内のメッセージボディと応答**
| 手順 | リクエスト内のメッセージボディ | 応答 |
| :--- | :--- | :--- |
| 1 | `sei=sato&mei=taro&mail=aaa%40example.jp&csrf_token=` | エラー |
| 2 | `sei=sato&mei=taro&mail=aaa%40example.jp` | エラー |
| 3 | `sei=sato&mei=taro&mail=aaa%40example.jp&csrf_token=(異なる利用者アカウントで取得した csrf_token の値)` | 正常に処理 |

3.  Z社は、手順1,2の応答が“エラー”であることから一定のCSRF 対策ができているが、手順3の応答が“正常に処理”であることから③<u>利用者に被害を与える可能性がある</u>と判断した。

Z社は、対策には二つの方法があることを説明した。

  - csrf token の処理の修正
  - cookie への SameSite 属性の追加

サイトXの構成次第では, SameSite 属性を cookie に付与することも有効な対策となり得る。SameSite 属性は, Strict, Lax, None の三つの値のうちのいずれかを取る。サイトXにログインした利用者の Web ブラウザにおいて、サイトX内で遷移する場合と外部 WebサイトからサイトXに遷移する場合では、SameSite 属性の値によってサイトXのcookie送信の有無が表3のように異なる。

**表3 SameSite 属性の値の違いによる cookie 送信の有無**
*注記 “○”は cookie が送られることを示す。“×”はcookieが送られないことを示す。*
| SameSite 属性の値 | サイトX内で遷移 (GET, POST) | 外部 WebサイトからサイトXに遷移 (GET) | 外部 WebサイトからサイトXに遷移 (POST) |
| :--- | :--- | :--- | :--- |
| Strict | ○ | <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">a</span> | <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">b</span> |
| Lax | ○ | <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">c</span> | <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">d</span> |
| None | ○ | (省略) | (省略) |

#### 〔認可制御の不備について〕

Z社が認可制御の不備を検出した経緯は、次のとおりであった。

1.  Z社は、利用者A,利用者Bという二つの利用者アカウントを用いて、注文履歴を閲覧した際のリクエストを確認した。注文履歴を閲覧した際のリクエストを図5及び図6に示す。

**図5 利用者Aで注文履歴を閲覧した際のリクエスト**
*注1) 表1の注文管理番号のことである。値から利用者を特定することができる。*

```http
POST /shop/order-history HTTP/1.1
Host: (省略)
(省略)
Content-Type: application/x-www-form-urlencoded
Content-Length: (省略)
Cookie: SESSIONID=ac9t66bxlxmwuiiki53h4nq3

order-code=202404-AHUJKI
```

**図6 利用者Bで注文履歴を閲覧した際のリクエスト**

```http
POST /shop/order-history HTTP/1.1
Host: (省略)
(省略)
Content-Type: application/x-www-form-urlencoded
Content-Length: (省略)
Cookie: SESSIONID=k1ctghbxbx5wuj3ki33hLng5

order-code=202404-BAKCXW
```

2.  図5のリクエストのパラメータ order-code の値を図6中の値に改変してリクエストを送った。
3.  利用者Aが、本来は閲覧できないはずの利用者Bの注文履歴を閲覧できるという攻撃が成功することを確認した。
4.  さらに、ある利用者がほかの利用者が注文した際のorder-code を知らなくても、④<u>ある攻撃手法を用いれば攻撃が成功すること</u>を確認した。

Z社は、⑤<u>サイトXのWebアプリに追加すべき処理</u>を説明した。

### 〔サイトYに対する Web アプリ診断〕

サイトYに対する Web アプリ診断では、次の脆弱性が検出された。

  - サーバサイドリクエストフォージェリ (以下、SSRF という)

#### [SSRF について]

Z社がSSRF を検出した経緯は、次のとおりであった。

1.  サイトPの新着情報を取得する際に、利用者の Web ブラウザが Web サーバYに送るリクエストを確認したところ、図7のとおりであった。

**図7 利用者の Web ブラウザがWebサーバYに送るリクエスト**
*注記 △△△.jpはサイトPのFQDNである。*

```http
GET /top?page=https://△△△.jp/topic/202404.html HTTP/1.1
Host: (省略)
(省略)
Cookie: SESSIONID=pq4ikd31op215jebter41sae
```

2.  ⑥<u>図7のリクエストのパラメータの値を Web サーバYのCMSの管理ログイン画面の URL に変更することで、その画面にアクセスできるが、ログインはできないこと</u>を確認した。
3.  ⑦<u>図7のリクエストのパラメータの値を別のURLに変更するという方法(以下, 方法Fという)でSSRFを悪用して、クレデンシャル情報を取得し、ストレージ Wから情報を盗み出すことができること</u>を確認した。
4.  IMDSにアクセスする方式を方式1から方式2に変更すると、方法Fではクレデンシャル情報を取得できないので、ストレージ Wから情報を盗み出すことができない。しかし、図7のリクエストのパラメータの値を変更することで、Web サーバYから送られるリクエストに任意のメソッドの指定及び任意のヘッダの追加ができる方法(以下、方法Gという)がある。方法Gを用いれば、方式2に変更しても、⑧<u>クレデンシャル情報を取得し、ストレージ Wから情報を盗み出すことができること</u>を確認した。

Z社は、クラウドW上のネットワークでのアクセス制御の設定、及び⑨<u>サイトYのWeb アプリに追加すべき処理</u>を提案した。

リリース前の脆弱性診断で検出された脆弱性の対策が全て完了し、サイトXとサイトYは稼働を開始した。

-----

### 設問1

[XSS について] について答えよ。
(1) 本文中の下線①について、図3中のリクエスト内のスクリプトが出力されるのはどの機能か。表1の詳細機能に対する項番を選び答えよ。
(2) 本文中の下線②について、攻撃者はどのような手順で利用者情報を取得するか。具体的に答えよ。

### 設問2

〔CSRF について〕について答えよ。
(1) 本文中の下線③について、被害を与える攻撃の手順を、具体的に答えよ。
(2) 表3中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">a</span> ～ <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">d</span> に入れる適切な内容を、“○”又は“×”から選び答えよ。

### 設問3

[認可制御の不備について] について答えよ。
(1) 本文中の下線④について、どのような攻撃手法を用いれば攻撃が成功するか。30字以内で答えよ。
(2) 本文中の下線⑤について、サイトXのWeb アプリに追加すべき処理を,60字以内で具体的に答えよ。

### 設問4

〔SSRF について〕について答えよ。
(1) 本文中の下線⑥について、ログインができないのはなぜか。SSRF 攻撃の特徴を基に、35字以内で答えよ。
(2) 本文中の下線⑦について、クレデンシャル情報を取得する方法を、具体的に答えよ。
(3) 本文中の下線⑧について、方法Gを用いてクレデンシャル情報を取得する方法を、具体的に答えよ。
(4) 本文中の下線⑨について、サイトYのWeb アプリに追加すべき処理を、35字以内で具体的に答えよ。

-----
