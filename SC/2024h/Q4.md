## 問4 Web アプリケーションプログラムに関する次の記述を読んで、設問に答えよ。

A社は、加工食品の製造・販売を行う従業員 500名の会社である。問屋や直販店からの注文の受付に、商品の注文と在庫を管理するシステム(以下、業務システムという)を利用している。業務システムは、A社内に設置したサーバ上に構築されている。
このたび、販売拡大を目指して、インターネットを使ったギフト販売を行うことになり、個人顧客から注文を受けるためのWebシステム(以下, Web 受注システムという)を構築することになった。
A社はITベンダーのB社との間で開発の委託契約を締結し、両社は Web 受注システムの開発に着手した。

### [Web 受注システムの要件]

Web 受注システムの要件を表1に示す。

**表1 Web受注システムの要件**
*注1) A社では、扱う情報を“重要情報”と“その他の情報”に分類している。*
*注2) システム稼働時に出力され、システム障害の際に、システム開発者が障害原因調査のために確認するファイルである。*
*注3) chmod コマンドの絶対モードでLinux のパーミッションを設定する。*
| No. | 要件名 | 要件内容 |
| :--- | :--- | :--- |
| 1 | 機能 | 個人顧客が利用できる機能: 商品検索,在庫照会,注文,決済,注文変更、注文キャンセル、注文照会、配送照会、ユーザー登録、ユーザー情報変更、パスワード変更、退会である。これら機能全てをアプリケーション(以下 AP という) サーバに実装する。<br>その他の機能:(省略) |
| 2 | アクセス方式 | Web ブラウザからインターネット経由でアクセスして利用する |
| 3 | 想定ユーザー | 個人顧客 |
| 4 | 想定ユーザー数 | 登録ユーザーの数が100,000までを想定 |
| 5 | 重要情報に該当するデータ項目 | 氏名,住所,電話番号、メールアドレス、パスワード、銀行口座情報,決済情報 |
| 6 | 商品数 | 1,000 |
| 7 | 想定トランザクション数 | 注文: 1,000件/日<br>注文変更・注文キャンセル: 各30件/日<br>注文照会・配送照会:各2,000件/日 |
| 8 | 稼働時間 | 24時間365日。ただし、メンテナンス時間は除く |
| 9 | メンテナンス時間 | 毎週月曜日 0:00~5:00。ただし、緊急の脆弱性修正プログラム適用など、他の日時に臨時でメンテナンスを実施する場合もある。 |
| 10 | 稼働率目標 | 99.9%。ただし、メンテナンス時間は除く |
| 11 | 開発体制 | A社とB社が協働で開発する。 |
| 12 | 開発言語/DBMS | Java/RDBMS |
| 13 | システム基盤 | AP サーバ、バッチサーバ、ログサーバは, IaaS 上に構築する。Web受注システムのデータベース(以下、データベースをDBという)は、クラウドサービスのマネージドDBを利用する。<br>本番環境は、本番 AP サーバ、本番バッチサーバ、本番ログサーバ、本番DBで構成する。<br>開発環境は、開発 AP サーバ、開発バッチサーバ、開発ログサーバ、開発DBで構成する。重要情報は保管されない。 |
| 14 | サーバ OS | AP サーバ、バッチサーバ、ログサーバのOSはLinuxを使用する |
| 15 | APログ²⁾ | AP サーバのプログラム及びバッチサーバのプログラムはAPログをログサーバに転送し、ログサーバは AP ログをテキストファイル形式で保存する。 |
| 16 | AP サーバの標準出力と標準エラー出力 | APサーバの標準出力と標準エラー出力は、リダイレクトしてAPサーバの/var/log/serverlog ディレクトリ配下のテキストファイルに出力する。なお、/var/log/server log ディレクトリのオーナーは webappuser であり、パーミッションは775³⁾とする。その配下のテキストファイルのオーナーは webappuser であり、パーミッションは664³⁾とする。 |
| 17 | システム運用 | システム運用はB社に委託し、システム運用担当者はB社の要員とする。<br>重要情報¹⁾の取扱いは重要情報取扱運用者だけとし、重要情報取扱運用者はA社での役職が管理職以上の要員とする。<br>各サーバ及び各 DB の管理はシステム管理責任者が行い、システム管理責任者はA社の情報システム部の管理職とする。 |
| 18 | システムのユーザーと役割 | (1) 個人顧客: Web 受注システムのAPサーバで注文、決済などを行う<br>(2) システム運用担当者: 本番 AP サーバ及び本番バッチサーバの稼働を監視する。バッチ処理が異常終了したときは、手動で再実行する。これら以外のサーバについては、統合監視システムの画面から死活監視だけを行う。重要情報にアクセスしてはならない。<br>(3) 重要情報取扱運用者: 本番環境に保管されている重要情報を参照し、個人顧客からの問合せに対応する。<br>(4) システム開発者: 開発環境においてプログラムの開発・保守を行う。障害発生時は、本番ログサーバにアクセスして障害原因を調査する。重要情報にアクセスしてはならない。<br>(5) システム管理責任者: 各サーバの OS, ミドルウェアの脆弱性修正プログラムの適用などのメンテナンス作業を行う。各サーバの OS アカウントを管理する。各DBのアカウント管理を行う。 |
| 19 | パスワードの保存 | パスワードは、CRYPTREC 暗号リスト (令和5年3月30日版)の電子政府推奨暗号リストに記載されているハッシュ関数でハッシュ化してDBに保存する。 |

### [Web 受注システムの設計]

A社とB社は Web 受注システムを設計した。
Web 受注システムのサーバで定義されるOS アカウントの一覧を表2に、所属グループとその権限を表3に示す。

**表2 OS アカウントの一覧**
*注記1) root, operation, personal, develop という所属グループは各サーバに定義されている。*
*注記2) 業務システムと Web 受注システムがデータ連携を行うための機能である。*
| No. | ユーザーID | 所属グループ | OS アカウントが定義されるサーバ | 説明 |
| :--- | :--- | :--- | :--- | :--- |
| 1 | root | root | (省略) | システム管理責任者が利用する |
| 2 | operator | operation | (省略) | システム運用担当者が利用する。 |
| 3 | personal | personal | (省略) | 重要情報取扱運用者が利用する。 |
| 4 | developer | develop | (省略) | システム開発者が利用する |
| 5 | batchappuser | operation | 本番バッチサーバ | データ連携機能²⁾の各プログラムの実行に利用される。 |
| 6 | webappuser | personal | 本番AP サーバ | AP サーバのプログラムの実行に利用される。 |

**表3 所属グループとその権限**
*注記) Web 受注システムでは、OSアカウントの権限を所属グループ単位で管理する。*
| No. | 所属グループ | 権限 |
| :--- | :--- | :--- |
| 1 | root | 特権ユーザーである。全てのアクセス権がある |
| 2 | operation | 一般ユーザー権限である。本番 AP サーバと本番バッチサーバへのアクセス権がある。 |
| 3 | personal | 一般ユーザー権限である。本番環境へのアクセス権がある。 |
| 4 | develop | 一般ユーザー権限である。開発環境と本番ログサーバへのアクセス権がある。 |

業務システムとWeb受注システムは、CSV形式のデータ連携用ファイル(以下、CSVファイルという)でデータ連携を行う。1時間ごとに業務システムのバッチサーバとWeb 受注システムのバッチサーバにおいて CSV ファイルを作成し、HTTPSで他方のバッチサーバに送信し、他方のバッチサーバでは受信したCSVファイルを保存する。保存した CSVファイルを使用して Web 受注システム又は業務システムのDBに対して更新処理を実行する。更新処理後のCSVファイルは、障害発生に備えて1週間保存する。データ連携機能のプログラム一覧を表4に示す。

**表4 データ連携機能のプログラム一覧**
| No. | プログラム名 | 実行するサーバ | 概要 |
| :--- | :--- | :--- | :--- |
| 1 | バッチ処理管理1 | Web 受注システムのバッチサーバ | Web 受注システムの各バッチ処理のプログラムの起動、監視などを行う。 |
| 2 | バッチ処理管理2 | 業務システムのバッチサーバ | 業務システムの各バッチ処理のプログラムの起動、監視などを行う。 |
| 3 | 注文データ CSV 出力バッチ処理 | Web 受注システムのバッチサーバ | Web 受注システムのDB 内の注文テーブルから注文データを取得し、CSVファイルに出力する。 |
| 4 | 注文データ CSV 取込みバッチ処理 | 業務システムのバッチサーバ | 保存された CSV ファイルを読み込んで、業務システムのDBを更新する。 |
| 5 | 在庫データ CSV 出力バッチ処理 | 業務システムのバッチサーバ | 業務システムのDB内の在庫テーブルから在庫データを取得し、CSVファイルに出力する。 |
| 6 | 在庫データ CSV 取込みバッチ処理 | Web 受注システムのバッチサーバ | 保存された CSV ファイルを読み込んで、Web受注システムのDBを更新する。 |
| 7 | データ送信1バッチ処理 | Web 受注システムのバッチサーバ | CSV ファイルを業務システムのバッチサーバにHTTPSで送信する。 |
| 8 | データ送信2バッチ処理 | 業務システムのバッチサーバ | CSV ファイルを Web 受注システムのバッチサーバにHTTPSで送信する。 |
| 9 | データ受信1バッチ処理 | Web 受注システムのバッチサーバ | 受信した CSVファイルを Web 受注システムのバッチサーバの指定されたディレクトリに保存する。 |
| 10 | データ受信2バッチ処理 | 業務システムのバッチサーバ | 受信した CSV ファイルを業務システムのバッチサーバの指定されたディレクトリに保存する。 |

表4のうち、No.3のプログラムの内容を図1に示す。

**図1 No.3のプログラムの内容(抜粋)**
*注1) “0”はCSVファイル出力前であることを、“1”はCSV ファイル出力後であることを示す。*
*注2) chmod コマンドの絶対モードでLinux のパーミッションを設定する。*
*注3) 主キーである。*

  - 注文テーブルの連携済フラグ¹⁾が0である注文データを、CSVファイルとして平文で/var/dataディレクトリに出力する。なお、/var/data ディレクトリのオーナーは batchappuserで、パーミッションは770²⁾とする。CSVファイルのオーナーは batchappuserで、パーミッションは660²⁾とする。
  - 注文テーブルの内容は、次のとおりである。
    注文 ID³⁾,注文番号、注文ユーザーID、注文日時,決済金額,銀行コード、銀行支店コード、預金種別,銀行口座番号,銀行口座氏名,注文ステータス、お届け先郵便番号、お届け先住所,お届け先電話番号、お届け先氏名、送り主郵便番号、送り主住所、送り主電話番号,送り主氏名、連携済フラグ

Web 受注システムの開発が進み、結合テスト前に、A社は、設計書とソースコードのセキュリティレビューを、セキュリティ専門会社のC社に委託した。C社の情報処理安全確保支援士(登録セキスペ)のE氏は、セキュリティレビューを実施した。

### [データ連携機能のセキュリティレビュー]

E氏は、表2~4及び図1の内容では表1の要件を満たしておらず、 <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">a</span> がCSV ファイルを閲覧できてしまうという問題を発見した。また、CSV ファイルには重要情報が記録されるので、本番バッチサーバにアクセスできる者が不正に閲覧するリスクを軽減するための保険的対策も併せて実施することを提案した。具体的には、次のように提案した。

1.  問題に対しては、表2のbatchappuser について、所属グループを <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">b</span> に変更する。
2.  保険的対策としては、表4のNo.3のプログラムに暗号化を行う処理を追加し、表4のNo. <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">c</span> のプログラムに復号を行う処理を追加する。

A社は、E氏の提案どおり修正することにした。

### [ユーザー登録機能のセキュリティレビュー]

ユーザー登録機能は、 UserData クラスによって実現している。UserData クラスのプログラム仕様を図2に、 UserData クラスのソースコードを図3に示す。

**図2 UserData クラスのプログラム仕様 (抜粋)**
*注1) 主キーである。オブジェクト IDであり、データを一意に識別する文字列が格納される。*
*注2) パスワードのハッシュ値が格納される。*

  - addUser メソッドは、データをユーザーマスターテーブルに挿入する。
  - 各インスタンス変数は、ユーザーマスターテーブルの各レコードに対応し、画面から入力された値を String 型で保持する。
  - ユーザーマスターテーブルの列名は、次のとおりである。
    ユーザーOID¹⁾, ユーザーID、パスワード²⁾,氏名,郵便番号,住所,電話番号,メールアドレス、作成日時、更新日時

**図3 UserData クラスのソースコード (抜粋)**
*注記) Log.debug()は、引数の文字列をログサーバに送信するメソッドである。*

```java
(省略) //package 宣言,import 宣言など
1: public UserData (HttpServletRequest request) {
2:   this.userId = request.getParameter("userId");
3:   this.password = request.getParameter("password");
     (省略) //入力値チェックなど
4:   try {
5:     MessageDigest mdObj = MessageDigest.getInstance("SHA-1");
6:     byte[] hashByte = mdObj.digest(this.password.getBytes());
7:     this.password = String.format("%x", new BigInteger (1, hashByte));
8:   } catch (NoSuchAlgorithmException e) {
9:     log.debug("error:" + e);
10:  }
11: }
(省略)
//引数 connはDBコネクションオブジェクトを示す。
12: public void addUser (Connection conn) {
13:   PreparedStatement psObj;
14:   String sql = "INSERT INTO USER_MASTER" +
15:                "(USER_OID, USER_ID, PASSWORD, USER_NAME, ZIP_CODE" +
16:                (省略);
17:   try {
18:     psObj = conn.prepareStatement(sql);
19:     psObj.setString(1, this.userOid);
20:     psObj.setString(2, this.userId);
21:     psObj.setString(3, this.password);
         (省略)
         //次の2行はデバッグログの出力
22:      System.out.println("SQL:" + sql);
23:      System.out.println("InsertData:" + this.toString());
         //次の2行はログサーバへのAP ログの出力
24:      log.debug("SQL:" + sql);
25:      log.debug("InsertData:" + this.toString());
26:      psObj.execute();
27:      conn.commit();
28:   } catch (SQLException e) {
         (省略) //例外処理
29:   }
(省略)
}
(省略)
```

E氏は、図3のソースコードについて、次のように指摘した。

  - パスワードからハッシュ値を得るためのハッシュ関数が、表1の要件を満たしていない。
  - 今後、メンテナンスなどで実行環境を変更した場合に、 <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">d</span> 行目で <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">e</span> が発生すると、25, 26行目では、パスワードが平文でユーザーマスターテーブルに保存されてしまう。
  - ①<u>システム運用担当者とシステム開発者が、要件でアクセスが禁止されている情報にアクセスできてしまう。</u>
  - 利用する AP サーバの実装では、変数 psObjの指すメモリ領域においてメモリリークが発生する可能性がある。

E氏の指摘を受け、システム開発者は、UserData クラスのソースコードを修正した。修正後の UserData クラスのソースコードを図4に示す。

**図4 修正後の UserData クラスのソースコード (抜粋)**

```java
(省略) //package宣言,import 宣言など
1: public UserData (HttpServletRequest request) {
2:   this.userId = request.getParameter("userId");
3:   this.password = request.getParameter("password");
     (省略) //入力値チェックなど
4:   try {
5:     MessageDigest mdObj = MessageDigest.getInstance("SHA-256");
6:     byte[] hashByte = mdObj.digest(this.password.getBytes());
7:     this.password = String.format("%x", new BigInteger (1, hashByte));
8:   } catch (NoSuchAlgorithmException e) {
9:     log.debug("error:" + e);
     //回復不能な例外発生
10:    g
11:  }
12: }
(省略)
//引数 connはDBコネクションオブジェクトを示す。
13: public void addUser (Connection conn) {
14:   PreparedStatement psObj = null;
15:   String sql = "INSERT INTO USER_MASTER" +
16:                "(USER_OID, USER_ID, PASSWORD, USER_NAME, ZIP_CODE" +
                 (省略);
17:   try {
18:     psObj = conn.prepareStatement(sql);
19:     psObj.setString(1, this.userOid);
20:     psObj.setString(2, this.userId);
21:     psObj.setString(3, this.password);
         (省略)
22:      UserData userMaskDataObj = this.maskUserData(this);
         //次の2行はログサーバへのAP ログの出力
23:      log.debug("SQL:" + sql);
24:      log.debug("InsertData:" + userMaskDataObj.toString());
25:      psObj.execute();
26:      conn.commit();
27:   } catch (SQLException e) {
28:     (省略) //例外処理
29:   } h {
30:     if (psObj != null) {
31:       try {
32:         psObj.close();
33:       } catch (SQLException e) {
34:         (省略) //例外処理
35:       }
36:     }
37:   }
(省略)
38: }
39: private UserData maskUserData (UserData inUserData) {
     (省略) //UserData 内の重要情報を含む変数の値を* に置換する。
     return userMaskDataObj;
   }
(省略)
```

図4のソースコードについて、E氏は、セキュリティレビューを再度実施した。E氏は、図4のソースコードでは、レインボーテーブル攻撃を受けたときに攻撃が成立してしまうので、図2の仕様及び②<u>図4のソースコードの6,7行目を修正すべき</u>であると指摘した。

A社は、E氏の指摘の対応を完了した。その後、テストを実施し、Web 受注システムをリリースした。

-----

*不備により設問2 (3) 「システム運用担当者」の「アクセスできてしまう情報」及び「出力される場所」は成立しない。(令和6年7月19日追記)*

### 設問1

[データ連携機能のセキュリティレビュー] について答えよ。
(1) 本文中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">a</span> に入れる適切な字句を、解答群の中から選び、記号で答えよ。
**解答群**
ア システム運用担当者
イ システム運用担当者とシステム開発者
ウ システム開発者
エ システム開発者と重要情報取扱運用者
オ 重要情報取扱運用者
(2) 本文中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">b</span> に入れる適切な所属グループを、表3中から選び答えよ。
(3) 本文中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">c</span> に入れる適切なプログラムを、表4中から選び、No.列の番号で答えよ。

### 設問2

[ユーザー登録機能のセキュリティレビュー〕について答えよ。
(1) 本文中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">d</span> に入れる適切な行番号を、図3中から選び、答えよ。
(2) 本文中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">e</span> に入れる適切な字句を答えよ。
(3) 本文中の下線①について、システム運用担当者とシステム開発者が、アクセスが禁止されているのにアクセスできてしまう情報は何か。図2中のユーザーマスターテーブルの列名で、それぞれ全て答えよ。また、その情報が出力される場所を、解答群の中から選び、それぞれ記号で答えよ。
**解答群**
ア 開発ログサーバのAPログを保存したテキストファイル
イ 本番 AP サーバの/sbinディレクトリ配下のバイナリファイル
ウ 本番 AP サーバの/var/data ディレクトリ配下のCSVファイル
エ 本番 AP サーバの/var/log/serverlog ディレクトリ配下のテキストファイル
オ 本番ログサーバのAPログを保存したテキストファイル
(4) 図4中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">f</span> に入れる適切な字句を答えよ。
(5) 図4中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">g</span> に入れる適切な処理を ソースコード又は具体的な処理内容のいずれかで答えよ。
(6) 図4中の <span style="display:inline-block; border: 1px solid black; padding: 0 10px; text-align: center;">h</span> に入れる適切なソースコードを答えよ。
(7) 本文中の下線②について、図4の6,7行目をどのように修正すればよいか。修正後の適切なソースコードを解答群の中から選び、記号で答えよ。ここで、変数 salt には, addUser メソッドの呼出しごとに異なる32 バイトの固定長文字列が入っているものとし、ユーザーマスターテーブルの定義に変更はないものとする。
**解答群**
| | |
| :--- | :--- |
| **ア** | `byte[] hashByte = mdObj.digest((salt + this.password).getBytes());` <br> `this.password = salt + String.format("%x", new BigInteger(1, hashByte));` |
| **イ** | `byte[] hashByte = mdObj.digest((salt + this.password).getBytes());` <br> `this.password = String.format("%x", new BigInteger (1, hashByte));` |
| **ウ** | `byte[] hashByte = mdObj.digest(this.password.getBytes());` <br> `byte[] saltByte = mdObj.digest(salt.getBytes());` <br> `this.password = String.format("%x", new BigInteger (1, hashByte)) + String.format("%x", new BigInteger(1, saltByte));` |
| **エ** | `byte[] hashByte = mdObj.digest(this.password.getBytes());` <br> `this.password = salt + String.format("%x", new BigInteger (1, hashByte));` |
| **オ** | `byte[] hashByte = mdObj.digest(this.password.getBytes());` <br> `this.password = String.format("%x", new BigInteger (1, hashByte));` <br> `byte[] saltHashByte = mdObj.digest((salt + this.password).getBytes());` <br> `this.password = String.format("%x", new BigInteger (1, saltHashByte));` |

